<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photo Editor_v_0.2</title>
    <style>
    body{
      position: fixed;    
      top: 0;
      bottom: 0;
      left: 0;
      right: 0;
      margin: 0;
      padding: 0;
    }
    /*Switch menu*/
    .editBlock ul {
    margin-top: 5px;    
    padding: 0 5px 0;
    margin-bottom: -1px;
    overflow: hidden;
    }
    .editBlock li {
    float:left;
    list-style: none;
    margin: 0 2px;
    }
    .editBlock li abbr {
      display: block;
      padding: 4px 8px;
      background: #F7F7F7;
      font-size: 14px;
      border: 1px solid #cccccc;
      border-radius: 2px 2px 0 0;
      cursor: pointer;
      text-decoration: none;        
    }
    .editFoto [name = content]{
      clear: both;
      display: none;
      border: 1px solid #cccccc;
      border-radius: 2px;
      background: #F7F7F7;
      overflow: auto;
      padding: 0.2rem 0.1rem;
      height: 12rem;
    }
    #resize{
      text-align: center;
    }
    hr{margin: 0.3rem;}

    /*Photo block*/
    .fotoBlock{   
      width: 80%;     
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: space-evenly;
      align-content: space-around;
      height: 100%;   
      /*Вид отображения результата*/
      --thumb-bgc-focus: hsla(0, 70%, 70%, 0.7);
      --thumb-bgc: hsl(0deg 100% 47% / 56%);
      --thumb-w: 0.2rem;
    } 
    #imgPreload, #imgSee{
      position: fixed;         
    }
    #canvasResult{
      display: none;
      /*Вид отображения результата*/
      clip-path: polygon(100% 0%, var(--value) 0%, var(--value) 100%, 100% 100%);
      background-image: url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="8" height="8" viewBox="0 0 8 8"%3E%3Cg fill="%239C92AC" fill-opacity="0.4"%3E%3Cpath fill-rule="evenodd" d="M0 0h4v4H0V0zm4 4h4v4H4V4z"/%3E%3C/g%3E%3C/svg%3E');
    } 
           
    /*Функционал*/
    .leftMiddleArea{
       position: absolute;
       left: 1%;
       width: 25px;                   
       cursor: pointer;
       text-align: center;
       padding: 5px;
      }       
    .chapter {
      height: 0.5rem;
      border-top: 2px solid rgba(0,0,0,.3);
    } 
    .activeFunction{
      background-color: rgba(255, 0, 0, 0.418);
    }
    /*Регулятор отображения изменений -  main*/    
    .c-compare__range{
      appearance: none;
      display: none;
    }
    .c-compare__range {
      background-color: transparent;
      box-sizing: border-box;
      font-family: inherit;
      height: 100%;
      margin: 0;
      outline: none;
      position: absolute;
      top: 0;
    }
    .c-compare__range::-moz-range-thumb {
      background-color: var(--thumb-bgc);
      cursor: ew-resize;
      height: 100%;  
      width: var(--thumb-w);
    }
    .c-compare__range::-webkit-slider-thumb {
      background-color: var(--thumb-bgc);
      cursor: ew-resize;
      height: 100%;  
      width: var(--thumb-w);
    }
    .c-compare__range:focus::-webkit-slider-thumb {
      background-color: var(--thumb-bgc-focus);
      box-shadow: 0 0 0 3px var(--thumb-bgc);
    }
    .c-compare__range:focus::-moz-range-thumb {
      background-color: var(--thumb-bgc-focus);
      box-shadow: 0 0 0 3px var(--thumb-bgc);
    }
    .c-compare__range::-moz-range-track {
      background: transparent;
      background-size: 100%;
      box-sizing: border-box;
    }
    .c-compare__range::-webkit-slider-runnable-track {
      background: transparent;
      background-size: 100%;
      box-sizing: border-box;
      height: 100%;
    }
    .c-compare__range,
    .c-compare__range::-webkit-slider-runnable-track,
    .c-compare__range::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
    }
    /*Information Display Editing Block*/
    .editBlock{
      padding-right: 0.5rem;
      width: 20%;
      position: absolute;
      top: 0;
      right: 0;
     }
    .editBlock p, h3{
       margin: 0;
     }
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
       -webkit-appearance: none;
       -moz-appearance: none;
       appearance: none;
       margin: 0;       
     }
    input[type="number"] {
       -moz-appearance: textfield;
       width: 35px;
     }
    #closetImg{
       position: absolute;
       top: 0;
       left: 0;
       margin: 2px;  
       cursor: pointer;
     }
    #closetImg p{
       margin: 0;  
       padding: 5px;
       background-color: red;     
       }
    .histogramInfo{
      border: 1px solid #cccccc;
      border-radius: 2px;
      background: #F7F7F7;
      cursor: pointer;
    }
    .histogramInfo::after{
      content: "\25BC";
      display: block;
      padding: 0 5px 0 5px;
      position: relative;
      float: right;
    }
    .histogramInfo.active::after {
      content: "\25B2";
      display: block;
      padding: 0 5px 0 5px;
      position: relative;
      float: right;
    }
    #canvasHistogram{
      width: 100%;     
      border: 1px solid #000;
     }
    .buttonEdit{
      display: block;
      text-align: center;
      margin-top: 3px;
    } 
    #closetImgSave{
      display: none;
      position: absolute;
      top: 35%;
      left: 25%;
      margin: 0 auto;
      text-align: center;
      border: 1px solid #cccccc;
      padding: 25px;
      background-color: #F7F7F7;
    }
    #inputPhoto{width: 100%;}
    .rangeEditColor{
      display: flex;
    }
    #rangeContrast, #rangeBrightness, #rangeSaturation, #rangeSharp{
      width: 80%;
    }
    #valueContrast, #valueBrightness, #valueSaturation, #valueSharp{
      width: 20%;
    }
    /*Отображения масштаба*/
    .scalrImg{
      position: absolute;
      animation: zoom 1s infinite 0s ease-in-out;
      display: none;
    }
    @keyframes zoom {
      0%{
        opacity: 0.08;
        font-size: 10px;
 				font-weight: 400;
				filter: blur(5px);
				letter-spacing: 3px;
        }
    100%{
        opacity: 1;
        font-size: 25px;
 				font-weight:600;
 				filter: blur(0);
        
        }
      }
    .anime {  
	      height:100%;
 	      width: 100%;
	      font-family: Helvetica, sans-serif, Arial;
	      animation: load 1.2s infinite 0s ease-in-out;
	      animation-direction: alternate;
	      text-shadow: 0 0 1px white;
      }
/*LOADER*/
/*
@keyframes load {
    0%{
        opacity: 0.08;
        font-size: 10px;
 				font-weight: 400;
				filter: blur(5px);
				letter-spacing: 3px;
        }
    100%{
        opacity: 1;
        font-size: 25px;
 				font-weight:600;
 				filter: blur(0);
        }
}
.animate {  
  background-color: gray;
  position: fixed;
	display:flex;
	justify-content: center;
	align-items: center;
	height:100%;
	margin: auto;
 	width: 100%;
 	font-size:26px;
	font-family: Helvetica, sans-serif, Arial;
	animation: load 1.2s infinite 0s ease-in-out;
	animation-direction: alternate;
	text-shadow: 0 0 1px white;
}
.fotoBlock{
	height: 96vh;
}
#loaded_hiding {
  transition: 0.3s opacity;
  opacity: 0;
}
*/
/*Media запрос*/
@media screen and (min-width: 875px){
  .minMonitor{display: none;}
}
@media screen and (max-width: 875px){
  .maxMonitor{display: none;}
}
@media screen and (max-height: 470px){
  .editFoto [name = content]{
      height: auto;
    }
    hr{
      margin: 0.1rem;
    }
    #scaleVersion{
      width: 100%;
    }
    .editColor p, h3{
      font-size: 0.8rem;
    }
    .histogram label{
      font-size: 0.8rem;
    }
    .editBlock p{
      font-size: 0.8rem;
    }
    #rangeContrast, #rangeBrightness, #rangeSaturation, #rangeSharp{
      width: 100%;
      margin: 0;
    }
    #valueContrast, #valueBrightness, #valueSaturation, #valueSharp{
      display: none;
    }
    .buttonEdit{
      position: fixed;
      top: 4px;
      left: 30px;
    }
}
</style>
</head>
<body>
    <div class="fotoBlock" id="fotoBlock">
      <div class="leftMiddleArea">
        <div class="chapter"></div>
        <img src="./icons/hand.svg" alt="moveHand" title="move" id="moveHand" class="elementLeftPanel">
        <div class="chapter"></div>
        <img src="./icons/zoom-plus.svg" alt="zoom plus" title="zoom plus" id="zoomPlus" class="elementLeftPanel">
        <div class="chapter"></div>
        <img src="./icons/zoom-minus.svg" alt="zoom minus" title="zoom minus" id="zoomMinus" class="elementLeftPanel">
        <div class="chapter"></div>
        <img src="./icons/flip.svg" alt="control view" title="Control view" id="controlView" class="elementLeftPanel">
        <div class="chapter"></div>
      </div>
      <!--<div id="loaded_hiding">
        <h2 class="animate">Loading</h2>
      </div>-->
      <img id="imgSee" src="./icons/pre-see.svg">             
      <img id="imgPreload" src="" style="display: none;">  
      <span id="scalrImg" class="scalrImg"></span>    
      <canvas id="canvasResult"></canvas>                      
      <input type="range" id="compareRange" class="c-rng c-compare__range" min="0" max="100" value="50" oninput="this.parentNode.style.setProperty('--value', `${this.value}%`)" />   
    </div> 
    
    <div id="closetImg">
      <p title="закрыть">X</p> 
    </div>
    <div id="closetImgSave">
      <p>Вы хотите сохранить изменения</p>
      <button id="closetImgSaveYes">Да</button>
      <button id="closetImgSaveNoy">Нет</button>
    </div>

    <div class="editBlock">
        
        <p id="histogramInfo" class="histogramInfo">Histogram</p>
        <div class="histogram">
          <label>
          <input name="rType" type="radio" id="typeValue"  checked/> b/w
          </label>
          <label>
          <input name="rType" type="radio" /> col
          </label>    
          <canvas id="canvasHistogram" width="256" height="150"></canvas>    
        </div>

        <p>For select custom image:</p>
        <input id="inputPhoto" type="file"/>

        
                  <h3>Edit photo</h3>
                  <!--MAX-->
                    <ul class="maxMonitor">
                      <li><abbr class="links" onclick="openMenu(event, 'editColor')" id="startEditColor" title="edit color">Color</abbr></li>
                      <li><abbr class="links" onclick="openMenu(event, 'resize')"  title="resize">Resiz</abbr></li>
                      <li><abbr class="links" onclick="openMenu(event, 'rotate')" title="rotate">Rotate</abbr></li>                  
                    </ul>
                  <!--MIN-->
                  <ul class="minMonitor">
                    <li><abbr class="links" onclick="openMenu(event, 'editColor')" id="startEditColor" title="edit color"><img src="./icons/color.svg" alt=""></abbr></li>
                    <li><abbr class="links" onclick="openMenu(event, 'resize')"  title="resize"><img src="./icons/resiz.svg" alt=""></abbr></li>
                    <li><abbr class="links" onclick="openMenu(event, 'rotate')" title="rotate"><img src="./icons/rotate.svg" alt=""></abbr></li>                  
                  </ul>  
                  <div class="editFoto" id="editFoto">  

                    <div class="editColor" id="editColor" name="content">     

                      <div class="links" id="contrast">
                        <p>Contrast</p>
                        <label class="rangeEditColor">
                          <input id="rangeContrast" type="range" name="contrast" min="-255" max="255" value="0" /> 
                          <input id="valueContrast" type="number" name="number" min="-255" max="255" value="0"/>   
                        </label>
                      </div>
                      
                      <div class="links" id="brightness">
                        <p>Brightness</p>
                        <label class="rangeEditColor">
                          <input id="rangeBrightness" type="range" name="brightness" min="-255" max="255" value="0" />
                          <input id="valueBrightness" type="number" name="number" min="-255" max="255" value="0"/>    
                        </label>
                      </div>
                      <hr>
                    
                      <div class="links" id="saturation">
                        <p>Saturation</p>
                        <label class="rangeEditColor">
                          <input id="rangeSaturation" type="range"  name="saturation" min="-255" max="255" value="0" />
                          <input id="valueSaturation" type="number" name="number" min="-255" max="255" value="0"/>  
                        </label>                
                      </div>
                      <hr>
              
                      <div class="links" id="sharp">
                        <p>Sharp</p>
                        <label class="rangeEditColor">
                          <input id="rangeSharp" type="range"  name="sharp" min="0" max="100" step="0.01" value="0" /> 
                          <input id="valueSharp" type="number" name="number" min="0.1" max="100" step="1" value="0"/>          
                        </label>
                      </div>

                    </div>
                  
                    <div class="links" id="resize" name="content">       
                        <p>Resize:</p>
                        <label id="inputScale">
                          <input id="numWidth" type="number" name="resiz" value="0"/>x<input class="closet" id="numHeight" type="number" name="resiz" value="0" disabled/>
                        </label>
                        <div>
                          <label>
                            <input id="cbProportions" type="checkbox" checked/>Proportions
                          </label>
                        </div>
                        <div>
                          <p>Scale methods:</p>
                          <select name="scaleVersion" id="scaleVersion" size="1">
                            <option value="neighbor" selected>Nearest neighbor scaling</option>
                            <option value="bilinear">Bilinear scaling</option>
                            <option value="lanczos">Lanczos scaling</option>
                          </select>    
                        </div>
                    </div>
                  
                    <div class="rotate" id="rotate" name="content">
                      <p>Rotate</p>
                      <div class="radioBlock" id="radioBlock">
                        <p><input type="radio" name="rotate" id="0" min="0" value="0" title="rotate 0deg" checked> - 0&#176;</p>
                        <p><input type="radio" name="rotate" id="90l" value="90" title="rotate 90deg left"> - 90&#176;</p>
                        <p><input type="radio" name="rotate" id="90r" value="-90" title="rotate 90deg right"> - 270&#176;</p>
                        <p><input type="radio" name="rotate" id="180" value="180" title="rotate 180deg left"> - 180&#176;</p>
                        <p><input type="radio" name="rotate" id="flip" value="270" title="mirror reflection"> - mirror</p>
                        <p><input type="radio" name="rotate" id="arbitrary" value="arbitrary" title="arbitrary"> - <input type="number" name="degrees" id="degrees" placeholder="&#177;0-90&#176;" value="0" minlength="1" maxlength="3" min="-90"  max="90" disabled></p>
                      </div>
                    </div>
                  </div>    

        <div class="buttonEdit">
            <button id="saveIMGBrauser">Save</button>  
            <button type="reset" form="reset" id="resetButton">Reset</button> 
        </div>

    </div>
</body>
</html>
<script>
//data collection
//Обьект с данными 
let clicks = {};   
//Размер Resize
let checked = document.getElementById("cbProportions");
let numWidth = document.getElementById("numWidth");
let numHeight = document.getElementById("numHeight");  
let inputScale = document.getElementById("inputScale"); 
let scaleVersion = document.getElementById("scaleVersion"); 
let nameScaleVersion;
//Основные блоки
let editColor = document.getElementById("editColor");
let resize = document.getElementById("resize");
let rotate = document.getElementById("rotate");
//img preload
let imgSee = document.getElementById("imgSee");
let imgPreload = document.getElementById("imgPreload");
//редоктирование img
let rotateImg = 0, flipHorizontal = 1, flipVertical = 1;  
//Left panel
//full
let nameLeftPanel;
let leftMiddleArea = document.querySelector(".leftMiddleArea");
//controlView
let compareRange = document.getElementById("compareRange");
let valueCompareRange = 50;
//ZOOM
let loaderZoomText = document.getElementById('scalrImg'); 
//histogram
let histograms = document.querySelector(".histogram");
let histogramInfo = document.getElementById("histogramInfo");
//data collection END

//loadImg
//Загружаем изображение
let img = new Image();
let canvas = document.getElementById("canvasResult");    
let ctx = canvas.getContext("2d");
    img.onload = initImg;
//Определяюшие размер фотоблока
let pageWidth = document.querySelector(".fotoBlock").offsetWidth;
let pageHeight = document.querySelector(".fotoBlock").offsetHeight;
//Определяюшие размер canvas блока
let pageCanvasWidth;
let pageCanvasHeight;
//img preload размер
imgSee.style.width = (pageWidth-(pageWidth*60/100))+"px"; 
//Дополнительная загрузка
let inputPhoto = document.getElementById("inputPhoto");
inputPhoto.addEventListener('change', function() {
    if (this.files && this.files[0]) { 
      //Убираем заставку
      imgSee.style = "display:none;"
      canvasResult.style = "display:block;"
      //сбрасываем все данные
      reset();
      //Добавляем img preload
      imgPreload.src = URL.createObjectURL(this.files[0]);   
      imgPreload.className = this.files[0].name; 
      //Выводим canvas
      img.src = URL.createObjectURL(this.files[0]);
      canvas.setAttribute("data-img",this.files[0].name); 
    }
})
//Действия после загрузки картинки
function initImg() {
    canvas.width = img.width;
    canvas.height = img.height;
    ctx.drawImage(img, 0, 0);
    //Выводим гистограмму
    histogram(new Uint32Array(getImage().data.buffer)); 
    //Выводим размеры картинки в Размер/Resize
    numWidth.value = img.width;
    numHeight.value = img.height;
    //приводим размер холста к соответствуюшему размеру экрана
      if(img.width > img.height){//horizontal img
          if (img.width >= pageWidth-(pageWidth*20/100)) {//big imagen
              //canvas
              canvas.style.width = (pageWidth-(pageWidth*20/100))+"px";
              canvas.style.height = "auto"; 
              //img
              imgPreload.style.width = (pageWidth-(pageWidth*20/100))+"px";
              imgPreload.style.height = "auto";
              //controlView
              compareRange.style.width = document.getElementById("canvasResult").offsetWidth+"px";
              //Определение размера canvas блока
              pageCanvasWidth = document.getElementById("canvasResult").offsetWidth;
              pageCanvasHeight = document.getElementById("canvasResult").offsetHeight;
            }else{
              //canvas
              canvas.style.width  = img.width+"px";
              canvas.style.height = "";
              //img
              imgPreload.style.width = img.width+"px";
              imgPreload.style.height = "";
              //controlView
              compareRange.style.width = document.getElementById("canvasResult").offsetWidth+"px";
              //Определение размера canvas блока
              pageCanvasWidth = document.getElementById("canvasResult").offsetWidth;
              pageCanvasHeight = document.getElementById("canvasResult").offsetHeight;
            } 
        }else if(img.width < img.height){//vertical img
          if (pageWidth <= pageHeight) {//big imagen
              //canvas
              canvas.style.width = (pageWidth-(pageWidth*20/100))+"px";
              canvas.style.height = ""; 
              //img
              imgPreload.style.width = (pageWidth-(pageWidth*20/100))+"px";
              imgPreload.style.height = ""; 
              //controlView
              compareRange.style.width = document.getElementById("canvasResult").offsetWidth+"px";
              //Определение размера canvas блока
              pageCanvasWidth = document.getElementById("canvasResult").offsetWidth;
              pageCanvasHeight = document.getElementById("canvasResult").offsetHeight;
            }else{
              //canvas
              canvas.style.width  = "";
              canvas.style.height = pageHeight+"px";
              //img
              imgPreload.style.width = "";
              imgPreload.style.height = pageHeight+"px";
              //controlView
              compareRange.style.width = document.getElementById("canvasResult").offsetWidth+"px";
              //Определение размера canvas блока
              pageCanvasWidth = document.getElementById("canvasResult").offsetWidth;
              pageCanvasHeight = document.getElementById("canvasResult").offsetHeight;
            } 
        }else if(img.width == img.height){//widh==height
          if (img.width >= pageWidth-(pageWidth*20/100)) {
              //canvas
              canvas.style.width = (pageWidth-(pageWidth*20/100))+"px";
              canvas.style.height = ""; 
              //img
              imgPreload.style.width = (pageWidth-(pageWidth*20/100))+"px";
              imgPreload.style.height = "auto";
              //controlView
              compareRange.style.width = document.getElementById("canvasResult").offsetWidth+"px";
              //Определение размера canvas блока
              pageCanvasWidth = document.getElementById("canvasResult").offsetWidth;
              pageCanvasHeight = document.getElementById("canvasResult").offsetHeight; 
          } else {
              //canvas
              canvas.style.width = img.width+"px";
              canvas.style.height = ""; 
              //img
              imgPreload.style.width = img.width+"px";
              imgPreload.style.height = "auto";
              //controlView
              compareRange.style.width = document.getElementById("canvasResult").offsetWidth+"px";
              //Определение размера canvas блока
              pageCanvasWidth = document.getElementById("canvasResult").offsetWidth;
              pageCanvasHeight = document.getElementById("canvasResult").offsetHeight;
          }
        }
}
//loadImg END

//Meny
//histogramInfo
histogramInfo.addEventListener("click",()=>{
  histogramInfo.classList.toggle("active");
if (histogramInfo.className == "histogramInfo active") {
  histograms.style.display = "none";
} else {
  histograms.style.display = "block";
}
})
//functional button EditionMenu
function openMenu(event, blockName) {
    //Declare all variables
    let tabcontent, tablinks;   
    // Get all elements with class="content" and hide them   
       tabcontent = document.getElementsByName("content");    
    for (let i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
    }
    //Get all elements with class="links" and remove the "active" class
        tablinks = document.getElementsByClassName("links");    
    for (let i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
    }
    //Show the current tab and add the "active" class to the button that opened the tab
    document.getElementById(blockName).style.display = "block";
    event.currentTarget.className += " active";
    //Маркер для определения какие действия производим - editColor/resiz/rotate   
    switch (blockName) {
      case 'editColor': canvas.setAttribute('name', 'editColor') ;      
        break;
      case 'resize': canvas.setAttribute('name', 'resize');      
        break;  
      case 'rotate': canvas.setAttribute('name','rotate');      
        break; 
    }
    //Передача информации для левой меню
    nameLeftPanel = blockName;  
    //Редоктирование анимации просмотршика изменений
    if (canvas.dataset.img !== undefined && document.getElementById("controlView").className == "elementLeftPanel activeFunction") {
      valueCompareRange = compareRange.value;
      if (blockName == "resize" || blockName == "rotate") {
         document.getElementById("controlView").style = "pointer-events : none; background-color: gray;";
         document.getElementById("fotoBlock").style.setProperty('--value', `0%`);
         compareRange.style.display = "none";
       }else{
         document.getElementById("controlView").style = "pointer-events : auto; background-color: whate;";
         compareRange.style.display = "block";
         document.getElementById("fotoBlock").style.setProperty('--value', valueCompareRange+`%`);
       } 
    }else{
       if (blockName == "resize" || blockName == "rotate") {
         document.getElementById("controlView").style = "pointer-events : none; background-color: gray;";
       }else{
         document.getElementById("controlView").style = "pointer-events : auto; background-color: whate;";
       } 
    }
}
//Моделируем нажатие на "rotate" при загрузки
document.getElementById("startEditColor").click();
//Переключатель Resize+Proportions
checked.addEventListener('click',function(){         
        if (numHeight.className =="open") {
          numHeight.className = "closet";
          numHeight.disabled = true;            
        } else {
          numHeight.className = "open";  
          numHeight.disabled = false;           
        } 
   })
//functional button controlViev
//full
for (let i = 0; i < leftMiddleArea.childNodes.length; i++) {
  leftMiddleArea.childNodes[i].addEventListener("click",(e)=>{
    if (canvas.dataset.img !== undefined) {
      if (nameLeftPanel == "editColor" && e.target.id == "controlView") {
        controlView();
        leftMiddleArea.childNodes[i].classList.toggle("activeFunction");
      } else {
        switch (e.target.id) {
        case "moveHand":
          moveHand();
          leftMiddleArea.childNodes[i].classList.toggle("activeFunction");
           break;
        case "zoomPlus": 
          zoomPlus();
           break;
        case "zoomMinus": 
          zoomMinus();
           break;
        }
       }
    }  
  }); 
}

//Действие при нажатии на клавишы клавиатуры
document.addEventListener('keyup', function (e) {
  if (e.which == 107) {zoomPlus();}
  if (e.which == 109) {zoomMinus();}
});
//Переменные для зумирования
let translatePos = {x: 0, y: 0};
let scale = 1.0;
let scaleMultiplier = 0.98; 
//Приближение
function zoomPlus() {
  scale /= scaleMultiplier;
  translatePos = {
  x: Math.floor((canvas.width-img.width*scale)/2) ,
  y: Math.floor((canvas.height-img.height*scale)/2)};
  loaderZoomText.style = "display: block";
  setTimeout(loaderZoomScale,1500);
  clickActionsSave();
};
//Удаление
function zoomMinus() {
  scale *= scaleMultiplier;
  translatePos = {
  x: Math.floor((canvas.width-img.width*scale)/2) ,
  y: Math.floor((canvas.height-img.height*scale)/2)};
  loaderZoomText.style = "display: block";
  setTimeout(loaderZoomScale,1500);
  clickActionsSave();
};
//Отключение текста отображения Масштаба
function loaderZoomScale() {      
  loaderZoomText.style ="display:none";
  }
//Переменные неоходимые для перемешения 
let startDragOffset = {};
let mouseDown = false;
//Перемешение
function moveHand() {
  if (document.getElementById("moveHand").className == "elementLeftPanel") {
    canvas.style.cursor = "move";
    // add event listeners to handle screen drag
    canvas.addEventListener("mousedown", function(evt) {//Кнопка мыши нажата над элементом
          mouseDown = true;
          startDragOffset = {
          x : Math.floor(evt.clientX - translatePos.x),
          y : Math.floor(evt.clientY - translatePos.y)};
      });

      canvas.addEventListener("mouseup", function() {//Кнопка мыши отпущена над элементом.
        mouseDown = false;
      });

      canvas.addEventListener("mouseover", function() {//Курсор мыши появляется над элементом
        mouseDown = false;
      });

      canvas.addEventListener("mouseout", function() {//Курсор уходит с него
        mouseDown = false;
      });
      canvas.addEventListener("mousemove", function(evt) {//Каждое движение мыши над элементом генерирует это событие.
       if (mouseDown && document.getElementById("moveHand").className !== "elementLeftPanel") {
        translatePos = {
          x : Math.floor(evt.clientX - startDragOffset.x),
          y : Math.floor(evt.clientY - startDragOffset.y)};
          clickActionsSave();
        }
      }, false); 
      
  }else{
    canvas.style.cursor = "default";
  }
};  
//Просмотр результата
function controlView() {
  valueCompareRange = compareRange.value;
  if (document.getElementById("controlView").className == "elementLeftPanel") {
    imgPreload.style.display = "block";
    compareRange.style.display = "block";
    imgPreload.style.opacity = "1"; 
    document.getElementById("fotoBlock").style.setProperty('--value', valueCompareRange+`%`);  
  } else {
    imgPreload.style.display = "none";
    compareRange.style.display = "none";
    imgPreload.style.opacity = "0"; 
    document.getElementById("fotoBlock").style.setProperty('--value', `0%`);  
  }
};
//Собирем переменные для редоктирования картинки
//Действия при нажатии  
let tabLinksEditFoto = document.getElementById("editFoto");
for (let i = 0; i < tabLinksEditFoto.children.length; i++) {
  let childrenElement = tabLinksEditFoto.children[i];
  childrenElement.addEventListener("click", clickActionsEffect);
  childrenElement.addEventListener("input", clickActions);
  childrenElement.addEventListener("input", clickActionsSave,true);
}

//Функция для прослушивания событий для сбора информации
function clickActionsEffect(e){
    //Получите все элементы с class="links" и удалите "активный" класс
    //editColor
    for (let i = 0; i < editColor.children.length; i++) {
        if (editColor.children[i].className) {
            editColor.children[i].className = editColor.children[i].className.replace(" active", "");
          }
    }
    //resize
    resize.className = resize.className.replace(" active", "");
    //rotate
    rotate.className = rotate.className.replace(" active", "");
    //Добавить класс «активный» к кнопке, которая открыла вкладку   
    if (document.getElementById(e.target.name) !== null)
    {
      document.getElementById(e.target.name).className += " active";
    }
}
function clickActions(e){
  //Выводим информацию по input
      //editColor    
      if (e.target.id == "rangeContrast" || e.target.id == "valueContrast") {
          document.getElementById("valueContrast").value = e.target.value;
          document.getElementById("rangeContrast").value = e.target.value;
        }
      if (e.target.id == "rangeBrightness" || e.target.id == "valueBrightness") {
          document.getElementById("valueBrightness").value = e.target.value;
          document.getElementById("rangeBrightness").value = e.target.value;
        }
      if (e.target.id == "rangeSaturation" || e.target.id == "valueSaturation") {
          document.getElementById("valueSaturation").value = e.target.value;
          document.getElementById("rangeSaturation").value = e.target.value;
        }
      if (e.target.id == "rangeSharp" || e.target.id == "valueSharp") {
          document.getElementById("valueSharp").value = e.target.value;
          document.getElementById("rangeSharp").value = e.target.value;
        } 
      //rotate  
      if ( document.getElementById("arbitrary").checked || e.target.id == "degrees") {
        document.getElementById("degrees").disabled = false;
      }else{
        document.getElementById("degrees").disabled = true;
      }
      //resize
      if (e.target.id == "resize" && numHeight.className =="closet") {
        numHeight.value = Math.round(img.height * numWidth.value / img.width);
      }
      
      //Добавляем маркер для определения перехода между типами input на CANVAS
      if (e.target.id == "resize" || e.target.id =="rotate" || e.currentTarget.id =="editColor") {
         canvas.setAttribute('class', e.target.id);  
      } else {
        canvas.setAttribute('class', e.target.name);
      }
}
//Функция событий, алгоритм выполнения после изменений
function clickActionsSave(e) {
  for (let i = 0; i < tabLinksEditFoto.children.length; i++) {
          let rozdil = tabLinksEditFoto.children[i];
          if (rozdil.id == "editColor") {
            let podrozdil = rozdil.children;
            for (let i = 0; i < podrozdil.length; i++) {         
              if (podrozdil[i].id) {
                if (podrozdil[i].getElementsByTagName('input')[1].value) {
                  clicks[podrozdil[i].getElementsByTagName('input')[0].id] = podrozdil[i].getElementsByTagName('input')[1].value;
                }else{
                  clicks[podrozdil[i].getElementsByTagName('input')[0].id] = podrozdil[i].getElementsByTagName('input')[0].value;
                }
              }
            }
          }     
          if (rozdil.id == "resize") {
            let podrozdil = rozdil.children[1]; 
            if (numHeight.className == "closet") {
              for (let i = 0; i < podrozdil.children.length; i++) {
              clicks[podrozdil.children[0].id] = podrozdil.children[0].value;
              clicks[podrozdil.children[1].id] =  String(Math.round(img.height * numWidth.value / img.width));
              }
            } else {
              for (let i = 0; i < podrozdil.children.length; i++) {
              clicks[podrozdil.children[0].id] = podrozdil.children[0].value;
              clicks[podrozdil.children[1].id] =  podrozdil.children[1].value;
              }
            }  
          } 
          if (rozdil.id == "rotate") {
            let podrozdil = rozdil.children[1];
            for (let i = 0; i < podrozdil.children.length+1; i++) {
              if (podrozdil.getElementsByTagName('input')[i].checked) {
                clicks[podrozdil.getElementsByTagName('input')[i].name] = podrozdil.getElementsByTagName('input')[i].value;
                //Управление controlView
                if (podrozdil.getElementsByTagName('input')[i].value === "0") {
                    //Изменяем положение Предкартинки
                    rotateImg = 0
                    flipVertical = 1;
                    flipHorizontal = 1;
                    //Изменяем положение и размер controlView
                    if(pageCanvasWidth > pageCanvasHeight || pageCanvasWidth == pageCanvasHeight){//horizontal img
                      if (pageWidth > pageHeight) {//Расширенный экран
                        //control Viev
                        imgPreload.style.width =  pageCanvasWidth+"px";
                        imgPreload.style.height =pageCanvasHeight+"px";
                        compareRange.style.width =  pageCanvasWidth+"px";
                        compareRange.style.height = ""; 
                        //canvas 
                        canvas.style.width =  pageCanvasWidth+"px";
                        canvas.style.height = "";
                      }else{//Суженный экран
                        //control Viev
                        compareRange.style.width = pageCanvasWidth+"px";
                        //canvas
                        canvas.style.width = pageCanvasWidth+"px";
                      }
                    }else{//vertikal img
                      if (pageWidth < pageHeight) {//Суженный экран
                      //control Viev
                      compareRange.style.width = pageCanvasWidth+"px";
                      imgPreload.style.height = pageCanvasHeight+"px";
                      compareRange.style.height ="";
                      //canvas
                      canvas.style.width = "";
                      canvas.style.height = pageCanvasHeight+"px";
                      }else{//Расширенный экран
                      //control Viev
                      compareRange.style.width = pageCanvasWidth+"px";
                      imgPreload.style.height = pageCanvasHeight+"px";
                      compareRange.style.height ="";
                      //canvas
                      canvas.style.width = "";
                      canvas.style.height = pageCanvasHeight+"px";
                      }
                    }
                  }else if (podrozdil.getElementsByTagName('input')[i].value === "90") {
                    //Изменяем положение Предкартинки
                    rotateImg = 90; 
                    flipHorizontal = 1;
                    flipVertical = 1;
                    //Изменяем положение и размер controlView
                    if(pageCanvasWidth > pageCanvasHeight || pageCanvasWidth == pageCanvasHeight){//horizontal img
                      if (pageCanvasWidth > pageHeight) {//Расширенный экран
                        //control Viev
                        imgPreload.style.width = pageHeight+"px";
                        imgPreload.style.height = pageHeight*pageCanvasHeight/pageCanvasWidth+"px";
                        compareRange.style.width = pageHeight*pageCanvasHeight/pageCanvasWidth+"px";
                        compareRange.style.height = pageHeight+"px";
                        //canvas 
                        canvas.style.width = pageHeight*pageCanvasHeight/pageCanvasWidth+"px";
                        canvas.style.height = pageHeight+"px";
                      } else {//Суженный экран
                        //control Viev
                        compareRange.style.width = pageCanvasHeight+"px";
                        //canvas 
                        canvas.style.width = pageCanvasHeight+"px";
                      }
                    }else{//vertikal img
                      if (pageWidth < pageHeight) {//Суженный экран
                      //control Viev
                      imgPreload.style.height =(pageWidth-(pageWidth*20/100))+"px";
                      imgPreload.style.width ="auto";
                      compareRange.style.width =(pageWidth-(pageWidth*20/100))+"px";
                      //canvas
                      canvas.style.width =  (pageWidth-(pageWidth*20/100))+"px";
                      canvas.style.height = "auto";
                      }else{//Расширенный экран
                      //control Viev
                      imgPreload.style.width = pageCanvasWidth+"px";
                      compareRange.style.width = pageCanvasHeight+"px";
                      compareRange.style.height = "";
                      //canvas
                      canvas.style.height = pageCanvasWidth+"px";
                      }
                    }  
                  } else if (podrozdil.getElementsByTagName('input')[i].value === "-90") {
                    //Изменяем положение Предкартинки
                    rotateImg = 270;
                    flipHorizontal = -1;
                    flipVertical = 1;
                    //Изменяем положение и размер controlView
                    if(pageCanvasWidth > pageCanvasHeight || pageCanvasWidth == pageCanvasHeight){//horizontal img
                      if (pageCanvasWidth > pageHeight) {//Расширенный экран
                        //control Viev
                        imgPreload.style.width = pageHeight+"px";
                        imgPreload.style.height = pageHeight*pageCanvasHeight/pageCanvasWidth+"px";
                        compareRange.style.width = pageHeight*pageCanvasHeight/pageCanvasWidth+"px";
                        compareRange.style.height = pageHeight+"px";
                        //canvas 
                        canvas.style.width = pageHeight*pageCanvasHeight/pageCanvasWidth+"px";
                        canvas.style.height = pageHeight+"px";
                      } else {//Суженный экран
                        //control Viev
                        compareRange.style.width = pageCanvasHeight+"px";
                        //canvas
                        canvas.style.width = pageCanvasHeight+"px";
                      }
                    }else{//vertikal img
                      if (pageWidth < pageHeight) {//Суженный экран
                      //control Viev
                      imgPreload.style.height =(pageWidth-(pageWidth*20/100))+"px";
                      imgPreload.style.width ="auto";
                      compareRange.style.width =(pageWidth-(pageWidth*20/100))+"px";
                      //canvas
                      canvas.style.width =  (pageWidth-(pageWidth*20/100))+"px";
                      canvas.style.height = "auto";
                      }else{//Расширенный экран
                      //control Viev
                      imgPreload.style.width = pageCanvasWidth+"px";
                      compareRange.style.width = pageCanvasHeight+"px";
                      compareRange.style.height = "";
                      //canvas
                      canvas.style.height = pageCanvasWidth+"px";
                      }
                    } 
                  } else if (podrozdil.getElementsByTagName('input')[i].value === "180") {
                    //Изменяем положение Предкартинки
                    rotateImg = 180;
                    flipHorizontal = -1;
                    //Изменяем положение и размер controlView
                    if(pageCanvasWidth > pageCanvasHeight || pageCanvasWidth == pageCanvasHeight){//horizontal img
                      if (pageCanvasWidth > pageHeight) {//Расширенный экран
                        //control Viev
                        imgPreload.style.width =  pageCanvasWidth+"px";
                        imgPreload.style.height =pageCanvasHeight+"px";
                        compareRange.style.width =  pageCanvasWidth+"px";
                        compareRange.style.height = ""; 
                        canvas.style.width =  pageCanvasWidth+"px";
                        canvas.style.height = pageCanvasHeight+"px";
                      } else {//Суженный экран
                        //control Viev
                        compareRange.style.width = pageCanvasWidth+"px";
                        //canvas
                        canvas.style.width = pageCanvasWidth+"px";
                      }
                    }else{//vertikal img
                      if (pageWidth < pageHeight) {//Суженный экран
                      //control Viev
                      compareRange.style.width = pageCanvasWidth+"px";
                      imgPreload.style.height = pageCanvasHeight+"px";
                      compareRange.style.height ="";
                      //canvas
                      canvas.style.height = pageCanvasHeight+"px";
                      }else{//Расширенный экран 
                      //control Viev
                      compareRange.style.width = pageCanvasWidth+"px";
                      imgPreload.style.height = pageCanvasHeight+"px";
                      compareRange.style.height ="";
                      //canvas
                      canvas.style.height = pageCanvasHeight+"px";
                      }
                    }  
                  } else if (podrozdil.getElementsByTagName('input')[i].value === "270") {
                    //Изменяем положение Предкартинки
                    rotateImg = 0;
                    flipHorizontal = -1;
                    //Изменяем положение и размер controlView
                    if(pageCanvasWidth > pageCanvasHeight){//horizontal img
                      if (pageCanvasWidth > pageHeight) {//Расширенный экран
                        //control Viev
                        imgPreload.style.width =  pageCanvasWidth+"px";
                        imgPreload.style.height = pageCanvasHeight+"px";
                        compareRange.style.width =  pageCanvasWidth+"px";
                        compareRange.style.height = ""; 
                        //canvas
                        canvas.style.width =  pageCanvasWidth+"px";
                        canvas.style.height = pageCanvasHeight+"px";
                      } else {//Суженный экран
                        //control Viev
                        compareRange.style.width = pageCanvasWidth+"px";
                        //canvas
                        canvas.style.width = pageCanvasWidth+"px";
                      }
                    }else{//vertikal img
                      if (pageWidth < pageHeight) {////Суженный экран
                      //control Viev
                      compareRange.style.width = pageCanvasWidth+"px";
                      imgPreload.style.height = pageCanvasHeight+"px";
                      compareRange.style.height ="";
                      //canvas
                      canvas.style.height = pageCanvasHeight+"px";
                      }else{//Расширенный экран 
                      //control Viev
                      compareRange.style.width = pageCanvasWidth+"px";
                      compareRange.style.height ="";
                      imgPreload.style.height = pageCanvasHeight+"px";
                      //canvas
                      canvas.style.height = pageCanvasHeight+"px";
                      }
                    }
                  }
              }
              if (podrozdil.getElementsByTagName('input')[i].id == "degrees") {
                clicks.degrees = podrozdil.getElementsByTagName('input')[i].value;
                //Управление controlView
                if (podrozdil.getElementsByTagName('input')[i].value > 0  || podrozdil.getElementsByTagName('input')[i].value < 0) {
                    //Изменяем положение Предкартинки
                    rotateImg = rotateImg === Math.sign(podrozdil.getElementsByTagName('input')[i].value) ? podrozdil.getElementsByTagName('input')[i].value : -podrozdil.getElementsByTagName('input')[i].value;
                    flipVertical = 1;
                    flipHorizontal = 1;
                    //Изменяем положение и размер controlView
                    const cosTheta = Math.cos(podrozdil.getElementsByTagName('input')[i].value* (Math.PI / 180));
                    const sinTheta = Math.sin(podrozdil.getElementsByTagName('input')[i].value* (Math.PI / 180));
                    //Расчет изменяюшейся ширины и высоты
                    const newWidth = Math.round(Math.abs(pageCanvasWidth * cosTheta) + Math.abs(pageCanvasHeight * sinTheta));
                    const newHeight = Math.round(Math.abs(pageCanvasWidth * sinTheta) + Math.abs(pageCanvasHeight * cosTheta));
                    if (newHeight > pageHeight) {
                        //canvas
                        canvas.style.width = "";    
                        canvas.style.height = pageHeight+"px";   
                      } else {
                        //control Viev
                        compareRange.style.width = newWidth+"px";
                        //canvas
                        canvas.style.width = newWidth+"px";
                        canvas.style.height = "";
                    }
                }
              }
            }
            applyFilter();  
          }

        } 
        console.log(clicks);
        if (canvas.dataset.img !== undefined) {  
          for (let index in clicks) {
            let clickItem = index, 
                clickValue = clicks[index];
                if (clickItem == "rangeContrast") {
                  editPicter(getImage(), clickItem, clickValue); 
                }
                if (clickItem == "rangeBrightness"  && clickValue !== "0") {
                  editPicter(getImageSave(), clickItem, clickValue); 
                }
                if (clickItem == "rangeSaturation" && clickValue !== "0") {
                  editPicter(getImageSave(), clickItem, clickValue);
                }
                if (clickItem == "rangeSharp"  && clickValue !== "0") {
                  editPicter(getImageSave(), clickItem, clickValue); 
                }
                if(clickItem == "rotate" && clickValue !== "0") {
                  editPicter(getImageSave(), clickValue, clickValue);
                }
                if(clickItem == "degrees"  && clickValue !== "0") {
                  editPicter(getImageSave(), clickItem, clickValue); 
                }
                if(clickItem == "numWidth" && parseInt(clickValue) !== canvas.width) {
                  editPicter(getImageSave(), clickItem, clickValue); 
                }
                if(clickItem == "numHeight"  && parseInt(clickValue) !== canvas.height) {
                  editPicter(getImageSave(), clickItem, clickValue); 
                }
                if (clickItem == "cbRed" && clickValue == true || clickItem == "cbGreen" && clickValue == true || clickItem == "cbBlue" && clickValue == true || clickItem == "cbAlpha" && clickValue == true ) {
                  editPicter(getImageSave(), clickItem, clickValue); 
                }
                if (clickItem == "discolorationClick" && clickValue == true) {
                  editPicter(getImageSave(), clickItem, clickValue); 
                }
                if (clickItem == "rangeR"  && clickValue !== "0" || clickItem == "rangeG"  && clickValue !== "0" || clickItem == "rangeB"  && clickValue !== "0" ) {
                  editPicter(getImageSave(), clickItem, clickValue); 
                }
                if (clickItem == "rangeH" && clickValue !== "0" || clickItem == "rangeS" && clickValue !== "0" || clickItem == "rangeL" && clickValue !== "0" ) {
                  editPicter(getImageSave(), clickItem, clickValue); 
                }
                if (clickItem == "rangeGamma" && parseInt(clickValue) !== 100) {
                  editPicter(getImageSave(), clickItem, clickValue); 
                }
                if (clickItem == "rangeSize"  && clickValue > 0) {
                  editPicter(getImageSave(), clickItem, clickValue); 
                }
                if (clickItem == "rangeHRadius"  && clickValue > 1) {
                  editPicter(getImageSave(), clickItem, clickValue); 
                }
                if (clickItem == "rangeVRadius"  && clickValue > 1) {
                  editPicter(getImageSave(), clickItem, clickValue); 
                }      
          }
        }  
}
//Редактирование IMG 
function applyFilter(){
  imgPreload.style.transform = `rotate(${rotateImg}deg) scale(${flipHorizontal}, ${flipVertical})`;
};
//Meny END

//FUNCTIONAL
//Редоктируем картинку
function editPicter(inCanvas, clickItem, clickValue) { 
  // Определите время начала выполнения функции
  let startTime = new Date().getTime();

        let src = new Uint32Array(inCanvas.data.buffer);
        let width = inCanvas.width;
        let height = inCanvas.height;
        let contrast = 0;
        let brightness = 0;
        let saturation = 0;
        let maxSaturation = 0;
        let mix = 0.01; 
        let angle;
        //Определяем тип обработки Resize          
        scaleVersion.addEventListener("change", function () {nameScaleVersion = scaleVersion.value;});
        if (clickItem == "rangeContrast") {contrast = parseInt(clickValue)/255;}
        else if(clickItem == "rangeBrightness"){brightness = parseInt(clickValue);}
        else if(clickItem == "rangeSaturation"){
          saturation = parseInt(clickValue);
          maxSaturation = (saturation < 0) ? 255 : 128;
        }
        else if(clickItem == "rangeSharp"){mix = (clickValue)*0.01;}     
        else if(clickItem == "degrees"){angle = Number(clickValue);} 
        
            //Contrast
            if (clickItem == "rangeContrast" ) {
                putImage(width, height, function (dst) {
                  let avgGray = 0;
                  for (let i = 0; i < dst.length; i++) {
                    let r = src[i] & 0xFF;
                    let g = (src[i] >> 8) & 0xFF;
                    let b = (src[i] >> 16) & 0xFF;
                    avgGray += (r * 0.2126 + g * 0.7152 + b * 0.0722);
                  }
                  avgGray /= dst.length;

                  for (let i = 0; i < dst.length; i++) {
                    let r = src[i] & 0xFF;
                    let g = (src[i] >> 8) & 0xFF;
                    let b = (src[i] >> 16) & 0xFF;

                    // Contrast
                    r += (r - avgGray) * contrast;
                    g += (g - avgGray) * contrast;
                    b += (b - avgGray) * contrast;
                    
                    if (r > 255) r = 255;
                    else if (r < 0) r = 0;
                    if (g > 255) g = 255;
                    else if (g < 0) g = 0;
                    if (b > 255) b = 255;
                    else if (b < 0) b = 0;

                    dst[i] = (src[i] & 0xFF000000) | (b << 16) | (g << 8) | r;
                  } 
                  histogram(dst);    
                })
            }
            //Brightness
            if ( clickItem == "rangeBrightness") {
                putImage(width, height, function (dst) {
                  let avgGray = 0;
                  for (let i = 0; i < dst.length; i++) {
                    let r = src[i] & 0xFF;
                    let g = (src[i] >> 8) & 0xFF;
                    let b = (src[i] >> 16) & 0xFF;
                    avgGray += (r * 0.2126 + g * 0.7152 + b * 0.0722);
                  }
                  avgGray /= dst.length;

                  for (let i = 0; i < dst.length; i++) {
                    let r = src[i] & 0xFF;
                    let g = (src[i] >> 8) & 0xFF;
                    let b = (src[i] >> 16) & 0xFF;


                    // Brightness
                    r += brightness;
                    g += brightness;
                    b += brightness;


                    if (r > 255) r = 255;
                    else if (r < 0) r = 0;
                    if (g > 255) g = 255;
                    else if (g < 0) g = 0;
                    if (b > 255) b = 255;
                    else if (b < 0) b = 0;

                    dst[i] = (src[i] & 0xFF000000) | (b << 16) | (g << 8) | r;
                  }  
                  histogram(dst);   
                })
            }
            //Saturation
            if (clickItem == "rangeSaturation") {
                putImage(width, height, function (dst) {
                  for (let i = 0; i < dst.length; i++) {
                    let r = src[i] & 0xFF;
                    let g = (src[i] >> 8) & 0xFF;
                    let b = (src[i] >> 16) & 0xFF;
                    let gray = (r * 0.2126 + g * 0.7152 + b * 0.0722);

                    r += (r - gray) * saturation / maxSaturation;
                    g += (g - gray) * saturation / maxSaturation;
                    b += (b - gray) * saturation / maxSaturation;

                    if (r > 255) r = 255;
                    else if (r < 0) r = 0;
                    if (g > 255) g = 255;
                    else if (g < 0) g = 0;
                    if (b > 255) b = 255;
                    else if (b < 0) b = 0;

                    dst[i] = (src[i] & 0xFF000000) | (b << 16) | (g << 8) | r;
                  }
                  histogram(dst);    
                })
            }
            //Sharp
            if (clickItem == "rangeSharp") {  
              putImage(width, height, function (dst) {
              //Все для работы с матрицей
              let kernel = [[0, -1, 0],//матрица
                           [-1, 5, -1],
                           [0, -1, 0]],
                  katet = Math.round(Math.sqrt(kernel.length))+1,//корень 9=3
                  half = (katet * 0.5) | 0,//3*0.5=1.5 отбрасываем значения после запятой
                  offset = 0,//offset - коэффициент
                  div = 1.0;//div - делитель        
              //обработка пикселей
              let dstIndex = 0;
                for (let y = 0; y < height; y++) {
                  for (let x = 0; x < width; x++) {
                    let r = 0, g = 0, b = 0;
                    for (let sy = 0; sy < katet; sy++) {
                      const yy = Math.min(height - 1, Math.max(0, y + sy - half));
                      for (let sx = 0; sx < katet; sx++) {
                        const xx = Math.min(width - 1, Math.max(0, x + sx - half));
                        let pix = src[yy * width + xx];//обробатываем информацию                     
                        r += ((pix & 0xFF) * kernel[sy][sx]);
                        g += ((((pix) >> 8) & 0xFF) * kernel[sy][sx]);
                        b += ((((pix) >> 16) & 0xFF) * kernel[sy][sx]);
                      }
                    }          
                    red = Math.min(255,Math.max(0, (r*mix)+((src[y * width + x] )&0xFF)*(1-mix) ))&0xFF;
                    green = Math.min(255, Math.max(0, (g*mix)+(((src[y * width + x])>> 8)&0xFF)*(1-mix) ))&0xFF;
                    blue = Math.min(255, Math.max(0, (b*mix)+(((src[y * width + x])>> 16)&0xFF)*(1-mix) ))&0xFF;
                    const alfa = src[y * width + x] & 0xFF000000;//обробатываем информацию
                    dst[dstIndex++] = red | ((green) << 8) | ((blue) << 16) | alfa ;//заполняем изменениями            
                  }
                }
                histogram(dst); 
              })
            }
            //Rotate 0
            if (clickItem == "0") {
                putImage(width, height, function (dst) {
                for (let i = 0; i < dst.length; i++) {
                dst[i] = src[i];
                }
                })
            }
            //Rotate 90
            if (clickItem == "90") {
                putImage(height, width, function (dst) {
                let newWidth = height;
                let newHeight = width;
                canvas.width = newWidth;
                canvas.height = newHeight;
                for (let y = 0; y < newHeight; y++) {
                  for (let x = 0; x < newWidth; x++) {
                    dst[y * newWidth + x] = src[(height - x - 1) * width + y];
                  }
                }                  
               })
            }
            //Rotate 270
            if (clickItem == "-90") {
                putImage(height, width, function (dst) {
                let newWidth = height;
                let newHeight = width;
                canvas.width = newWidth;
                canvas.height = newHeight;
                for (let y = 0; y < newHeight; y++) {
                  for (let x = 0; x < newWidth; x++) {
                    dst[y * newWidth + x] = src[x * width + y];
                  }
                }
                })
            }
            //Rotate 180
            if (clickItem == "180") {
                putImage(width, height, function (dst) {
                for (let y = 0; y < height; y++) {
                  for (let x = 0; x < width; x++) {
                    dst[y * width + x] = src[(height - y - 1)  * width + x];
                  }
                }               
                })
            }   
            //Rotate flip
            if (clickItem == "270") {
                putImage(width, height, function (dst) {
               for (let y = 0; y < height; y++) {
                for (let x = 0; x < width; x++) {
                    dst[y * width + x] = src[y * width + (width - x - 1)];
                  }
                }          
                })         
            }
            //Rotate Degress
            if (clickItem == "degrees" ) {
                    const cosTheta = Math.cos(clickValue* (Math.PI / 180));
                    const sinTheta = Math.sin(clickValue* (Math.PI / 180));
                    //Расчет изменяюшейся ширины и высоты
                    const newWidth = Math.round(Math.abs(width * cosTheta) + Math.abs(height * sinTheta));
                    const newHeight = Math.round(Math.abs(width * sinTheta) + Math.abs(height * cosTheta));
                    canvas.width = newWidth;
                    canvas.height = newHeight;
                putImage(newWidth, newHeight, function (dst) {
                  rotateDegress(newWidth, newHeight, cosTheta, sinTheta, dst, src);
                }) 
                  function rotateDegress(newWidth, newHeight, cosTheta, sinTheta, dst, src) {
                    //Метод ближайшего соседа(не самый лучший)
                    const centerX = newWidth / 2;
                      const centerY = newHeight / 2;
                      for (let y = 0; y < newHeight; y++) {
                          for (let x = 0; x < newWidth; x++) {
                              const destIndex = y* newWidth + x;
                              const rotatedX = Math.round((x - centerX) * cosTheta - (y - centerY) * sinTheta + width / 2);
                              const rotatedY = Math.round((x - centerX) * sinTheta + (y - centerY) * cosTheta + height / 2);
                              if (rotatedX >= 0 && rotatedX < width && rotatedY >= 0 && rotatedY < height) {
                                const srcIndex = rotatedY * width + rotatedX;
                                dst[destIndex] = src[srcIndex];
                                dst[destIndex + 1] = src[srcIndex + 1];
                                dst[destIndex + 2] = src[srcIndex + 2];
                                dst[destIndex + 3] = src[srcIndex + 3];
                              }
                          }
                      } 
                      return dst;
                  }   
            }
            //Resize
            if (clickItem == "numWidth" || clickItem == "numHeight") {
              let newWidth = numWidth.value;
              if (numHeight.className =="closet") {numHeight.value = Math.round(img.height * numWidth.value / img.width);}
              let newHeight = numHeight.value;
              canvas.width = newWidth;
              canvas.height = newHeight;
              putImage(newWidth, newHeight, function (dst) {
                if (nameScaleVersion == "bilinear") {
                    //Bilinear scaling
                    function interpolate(a, b, c, d, width, height) {
                    return a * (1 - width) * (1 - height)
                        + b * width * (1 - height)
                        + c * (1 - width) * height
                        + d * width * height;
                    }
                    const xMax = (width - 1);
                    const yMax = (height - 1);
                    const dx = (xMax + 0.5) / newWidth;
                    const dy = (yMax + 0.5) / newHeight;
                    let dstOffset = 0;
                    for (let i = 0; i < newHeight; i++) {
                      for (let j = 0; j < newWidth; j++) {
                        const x = (dx * j) >> 0;
                        const y = (dy * i) >> 0;
                        const xDiff = (dx * j) - x;
                        const yDiff = (dy * i) - y;
                        const index = y * width + x;
                        // a b
                        // c d
                        const a = src[index];
                        const b = (x >= xMax) ? a : src[index + 1];
                        const c = (y >= yMax) ? a : src[index + width];
                        const d = (y >= yMax) ? b
                            : ((x >= xMax) ? c : (src[index + width + 1]))
                        const red = interpolate(
                            a & 0xff, b & 0xff,
                            c & 0xff, d & 0xff,
                            xDiff, yDiff) >> 0;
                        const green = interpolate(
                            (a >> 8) & 0xff, (b >> 8) & 0xff,
                            (c >> 8) & 0xff, (d >> 8) & 0xff,
                            xDiff, yDiff) >> 0;
                        const blue = interpolate(
                            (a >> 16) & 0xff, (b >> 16) & 0xff,
                            (c >> 16) & 0xff, (d >> 16) & 0xff,
                            xDiff, yDiff) >> 0;
                        const alpha = interpolate(
                            (a >> 24) & 0xff, (b >> 24) & 0xff,
                            (c >> 24) & 0xff, (d >> 24) & 0xff,
                            xDiff, yDiff) >> 0
                        dst[dstOffset++] = (alpha << 24) | (blue << 16) | (green << 8) | red;
                      }
                    } 
              }else if(nameScaleVersion == "lanczos") {
                    //Lanczos scaling
                    let filterSize = 1;//меняется 1,2,3
                    function lanczos(size, x) {
                      if (x >= size || x <= -size) return 0;
                      if (x === 0) return 1;
                      const xpi = x * Math.PI;
                      return size * Math.sin(xpi) * Math.sin(xpi / size) / (xpi * xpi);
                    }
                    function createCache(cachePrecision, filterSize) {
                    const cache = {};
                    const max = filterSize * filterSize * cachePrecision;
                    const iPrecision = 1.0 / cachePrecision;
                    for (let cacheKey = 0; cacheKey < max; cacheKey++) {
                      const value = lanczos(filterSize, Math.sqrt(cacheKey * iPrecision));
                      cache[cacheKey] = value < 0 ? 0 : value;
                    }
                     return cache;
                    };
                    const values = [];
                    const sx = newWidth / width;
                    const sy = newHeight / height;
                    const xMax = width - 1;
                    const yMax = height - 1;
                    const csx = Math.min(1, sx) * Math.min(1, sx);
                    const csy = Math.min(1, sy) * Math.min(1, sy);
                    const cachePrecision = 1000;
                    const cache = createCache(cachePrecision, filterSize);
                    let x1et, y1et;
                    let y = newHeight;
                    while (y--) {
                      const sourcePixelY = (y + 0.5) * (1.0 / sy);
                      let y1b = sourcePixelY - filterSize;
                      if (y1b < 0) y1b = 0;
                      let y1e = y1et = sourcePixelY + filterSize;
                      if (y1e != y1et) y1e = y1et + 1;
                      if (y1e > yMax) y1e = yMax;
                      const cy = y * (1.0 / newHeight) - sourcePixelY;
                      const y3 = y * newWidth;
                      let x = newWidth;
                      while (x--) {
                        const sourcePixelX = (x + 0.5) * (1.0 / sx);
                        let x1b = sourcePixelX - filterSize;
                        if (x1b < 0) x1b = 0;
                        let x1e = x1et = sourcePixelX + filterSize;
                        if (x1e != x1et) x1e = x1et + 1;
                        if (x1e > xMax) x1e = xMax;
                        const cx = x * (1.0 / newWidth) - sourcePixelX;
                        ///
                        let total = 0;
                        let i = 0;
                        for (let y1 = y1b >> 0; y1 <= y1e; y1++) {
                          const distanceY = (y1 + cy) * (y1 + cy) * csy;
                          for (let x1 = x1b >> 0; x1 <= x1e; x1++) {
                            total += values[i++] = cache[(((x1 + cx) * (x1 + cx) * csx + distanceY) * cachePrecision) >> 0] || 0;
                          }
                        }
                        total = 1.0 / total;
                        ///
                        let a = 0;
                        let r = 0;
                        let g = 0;
                        let b = 0;
                        i = 0;
                        for (let y1 = y1b >> 0; y1 <= y1e; y1++) {
                          const y2 = y1 * width;
                          for (let x1 = x1b >> 0; x1 <= x1e; x1++) {
                            const value = values[i++] * total;
                            const pix = src[((y2 + x1) >> 0)];
                            r += (pix & 0xFF) * value;
                            g += ((pix >> 8) & 0xFF) * value;
                            b += ((pix >> 16) & 0xFF) * value;
                            a += (((pix >> 24) & 0xFF)) * value;
                          }
                        }
                        dst[((x + y3) >> 0)] = (a << 24) | (b << 16) | (g << 8) | r;
                      }
                    } 
                }else{
                      //Nearest neighbor scaling
                      const dx = width / newWidth;
                        const dy = height / newHeight;
                        for (let y = 0; y < newHeight; y++) {
                          let srcY = (y * dy) >> 0;
                          for (let x = 0; x < newWidth; x++) {
                            let srcX = (x * dx) >> 0;
                            dst[y * newWidth + x] = src[srcY * width + srcX];
                          }
                      }
                } 
              })
            }
            
// Определите время завершения выполнения функции
let endTime = new Date().getTime();
// Вычислите время выполнения функции в миллисекундах
let executionTime = endTime - startTime;
// Выведите время выполнения функции в консоль
console.log(' Время выполнения функции '+ clickItem +' : ' + executionTime + ' миллисекунд');
}
//Собираем информацию с Canvas
function getImage() {
  canvas.width = img.width;
  canvas.height = img.height;
  document.getElementById("scalrImg").innerHTML = "<span class = 'anime'>Scale: "+Math.floor(scale*100)+" % </span>"
  ctx.drawImage(img, translatePos.x , translatePos.y, canvas.width*scale, canvas.height*scale);
  //Передаем информацию в функцию для редоктирования картинки  
  return ctx.getImageData(0, 0, canvas.width, canvas.height);      
}
//Собираем информацию с Canvas после внесения изменений
function getImageSave() {
    //Передаем информацию в функцию для редоктирования картинки
    return ctx.getImageData(0, 0, canvas.width, canvas.height);    
}

//Записываем информацию на Canvas
function putImage(width, height, func) {
    const outImagen = ctx.createImageData(width, height);
    const dst = new Uint32Array(outImagen.data.buffer);
    func(dst);
    //Очишаем холст
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    //выводим измения 
    ctx.putImageData(outImagen, 0, 0);
}
//FUNCTIONAL END

//histogram
//Гистограмма
function histogram(dst) {
    //переключаем отображения гистограммы
    const isValueHistogram = document.getElementById('typeValue').checked; 
    let histBrightness = (new Array(256)).fill(0);
    let histR = (new Array(256)).fill(0);
    let histG = (new Array(256)).fill(0);
    let histB = (new Array(256)).fill(0);
    for (let i = 0; i < dst.length; i++) {
      let r = dst[i] & 0xFF;
      let g = (dst[i] >> 8) & 0xFF;
      let b = (dst[i] >> 16) & 0xFF;
      histBrightness[r]++;
      histBrightness[g]++;
      histBrightness[b]++;
      histR[r]++;
      histG[g]++;
      histB[b]++;
    }
    
    let maxBrightness = 0;
    if (isValueHistogram) {
      for (let i = 1; i < 256; i++) {
        if (maxBrightness < histBrightness[i]) {
          maxBrightness = histBrightness[i]
        }
      }
    } else {
      for (let i = 0; i < 256; i++) {
        if (maxBrightness < histR[i]) {
          maxBrightness = histR[i]
        } else if (maxBrightness < histG[i]) {
          maxBrightness = histG[i]
        } else if (maxBrightness < histB[i]) {
          maxBrightness = histB[i]
        }
      }
    }
    
    const canvas = document.getElementById('canvasHistogram');
    const ctx = canvas.getContext('2d');
    let guideHeight = 8;
    let startY = (canvas.height - guideHeight);
    let dx = canvas.width / 256;
    let dy = startY / maxBrightness;
    ctx.lineWidth = dx;
    ctx.fillStyle = "#fff";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    for (let i = 0; i < 256; i++) {
      let x = i * dx;
      if (isValueHistogram) {
        // Value
        ctx.strokeStyle = "#000000";
        ctx.beginPath();
        ctx.moveTo(x, startY);
        ctx.lineTo(x, startY - histBrightness[i] * dy);
        ctx.closePath();
        ctx.stroke(); 
      } else {
        // Red
        ctx.strokeStyle = "rgba(220,0,0,0.5)";
        ctx.beginPath();
        ctx.moveTo(x, startY);
        ctx.lineTo(x, startY - histR[i] * dy);
        ctx.closePath();
        ctx.stroke(); 
        // Green
        ctx.strokeStyle = "rgba(0,210,0,0.5)";
        ctx.beginPath();
        ctx.moveTo(x, startY);
        ctx.lineTo(x, startY - histG[i] * dy);
        ctx.closePath();
        ctx.stroke(); 
        // Blue
        ctx.strokeStyle = "rgba(0,0,255,0.5)";
        ctx.beginPath();
        ctx.moveTo(x, startY);
        ctx.lineTo(x, startY - histB[i] * dy);
        ctx.closePath();
        ctx.stroke(); 
      }
      // Guide
      ctx.strokeStyle = 'rgb(' + i + ', ' + i + ', ' + i + ')';
      ctx.beginPath();
      ctx.moveTo(x, startY);
      ctx.lineTo(x, canvas.height);
      ctx.closePath();
      ctx.stroke(); 
    }  
}

//переключатель для гистограммы ч-б/цветное
let switchHistogram = document.getElementsByName("rType");
for (let i = 0; i < switchHistogram.length; i++) { 
  switchHistogram[i].addEventListener('change',()=>{
    if (canvas.dataset.img !== undefined) {
      clickActionsSave();
    } 
  });
}
//histogram END

//Reset
//1 Meny
  let resetPages = document.getElementById("resetButton");
  resetPages.addEventListener('click', reset);
  function reset(){ 
      if (canvas.dataset.img !== undefined) {
        let inputSizeColor = editColor.getElementsByTagName('input'),
        inputRangeScale = document.getElementsByName("resiz"),
        inputRotation = rotate.getElementsByTagName("input");
      

        //Color+scale
        for (let i = 0; i <= inputSizeColor.length; i++) 
        {
          if(inputSizeColor[i]  || inputRangeScale[i] ){
            //main
            inputSizeColor[i].value = 0;
          }
        }
      
        //scale
          numWidth.value = img.width;
          numHeight.value = img.height; 
          numHeight.className = "closet"; 
          numHeight.disabled = true;
          checked.checked =true;
          scaleVersion[0].selected = true;

          //rotations
          inputRotation[0].checked = true;
          inputRotation[6].setAttribute("disabled","");
          inputRotation[6].value = 0;
          //Обнуление данных IMG
          rotateImg = 0
          flipVertical = 1;
          flipHorizontal = 1;
          applyFilter();
          //Изменяем положение и размер controlView
          compareRange.style.width = img.width+"px";

          //Удаление зумирования
          scale = 1;
          translatePos = {x: 0 ,y: 0};
          document.getElementById("scalrImg").style = "display: none";
          document.getElementById("moveHand").className = "elementLeftPanel";
          canvas.style.cursor = "default";

          //удаляем метку для сохранения картинки
          document.getElementById("canvasResult").removeAttribute("class");
          //Загрузем сново картинку
          clickActionsSave();
      }
    }
//2 PhotoEditor
let closetImg = document.getElementById("closetImg");
closetImg.addEventListener("click",()=>{window.location.reload();})
//Reset END

//SAVE
//Сохраняем  картинку в браузере
var saveIMGBrauser = document.getElementById('saveIMGBrauser');
//Сохраняем на прямую
saveIMGBrauser.addEventListener("click", ()=>{saveImg()})
//Обшая функция сохранения
function saveImg() {
    var dataURL = canvas.toDataURL("image/jpeg",1.0);//подгатавливаем данные для передачи  data:[<тип данных>][;base64],<данные>
    var link = document.createElement("a");//создаем ссылку
    document.body.appendChild(link); // Firefox требует, чтобы ссылка была в теле :(
    link.href = dataURL;
    link.download = canvas.dataset.img;
    link.click();
    document.body.removeChild(link);      
} 
//SAVE END

/**Loader**/
//Loader
/*
function loaderAction() {      
  let loaderAction = document.getElementById('loaded_hiding');  
  loaderAction.style.opacity ="1";
  }
setTimeout(loaderAction,1000);*/  
</script>